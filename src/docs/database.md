# æ•°æ®åº“é…ç½®ï¼šä» SQLite åˆ° PostgreSQL

## æ ¸å¿ƒè®¤çŸ¥çªç ´

### Prisma åˆ†å±‚æ¶æ„

```
PostgreSQL (çœŸå®æ•°æ®åº“)
    â†‘
DATABASE_URL (è¿æ¥å­—ç¬¦ä¸²)
    â†‘
Adapter (pg driver) â† Prisma 7.x å¿…éœ€
    â†‘
Prisma Client (ä»£ç è®¿é—®å±‚)
    â†‘
Prisma Schema (ç»“æ„å£°æ˜)
    â†‘
Prisma Migrate (ç»“æ„æ‰§è¡Œ)
```

### å…³é”®æ¦‚å¿µ

| æ¦‚å¿µ | ä½œç”¨ | æ‰§è¡Œ |
|------|------|------|
| **Schema** | `.prisma` æ–‡ä»¶ï¼Œå£°æ˜æ•°æ®æ¨¡å‹ | âŒ ä¸æ“ä½œæ•°æ®åº“ |
| **Migrate** | `prisma migrate dev` | âœ… ç”Ÿæˆ SQL å¹¶æ‰§è¡Œåˆ°æ•°æ®åº“ |
| **Generate** | `prisma generate` | âœ… ç”Ÿæˆ TypeScript å®¢æˆ·ç«¯ä»£ç  |
| **Adapter** | è¿è¡Œæ—¶æ•°æ®åº“é©±åŠ¨ | âœ… è¿æ¥æ•°æ®åº“ï¼ˆPrisma 7.x å¿…éœ€ï¼‰|

**æ ¸å¿ƒåŒºåˆ†**ï¼š
- `schema` æ˜¯å£°æ˜ â†’ `migrate` æ˜¯æ‰§è¡Œ
- `generate` ç”Ÿæˆä»£ç  â‰  ä¿®æ”¹æ•°æ®åº“
- `adapter` å†³å®š"æ€ä¹ˆè¿"ï¼Œä¸æ˜¯"è¿ä»€ä¹ˆ"

---
### å„æ•°æ®åº“å¯¹åº”çš„ Adapter

| æ•°æ®åº“ | Adapter åŒ… | Driver |
|--------|-----------|--------|
| PostgreSQL | `@prisma/adapter-pg` | `pg` |
| MySQL | `@prisma/adapter-mysql2` | `mysql2` |
| SQLite | `@prisma/adapter-better-sqlite3` | `better-sqlite3` |

---

## æ•°æ®åº“æ“ä½œæµç¨‹
### å¼€å‘ç¯å¢ƒ
* ä¿®æ”¹ schema çš„å®šä¹‰ä¹‹åï¼Œéœ€è¦æ‰§è¡Œ `pnpm run db:dev:migrate` æ¥ç”Ÿæˆè¿ç§»æ–‡ä»¶
* åŒæ—¶éœ€è¦ç”Ÿæˆæ–°çš„å®¢æˆ·ç«¯ä»£ç 
* è¿ç§»æ–‡ä»¶å’Œå®¢æˆ·ç«¯ä»£ç çš„ç”Ÿæˆéƒ½æ˜¯ç»Ÿä¸€ä»¥ schema çš„å®šä¹‰ä¸ºä¾æ®çš„ã€‚
* æœ€åå¯ä»¥æ‰§è¡Œå¡«å……ç§å­çš„é€»è¾‘

### ç”Ÿäº§ç¯å¢ƒ

```bash
# åªæ‰§è¡Œè¿ç§»ï¼Œä¸ç”Ÿæˆè¿ç§»æ–‡ä»¶
pnpm run db:prod:deploy
# ç­‰ä»·äºï¼šprisma migrate deploy
```

### é‡ç½®æ•°æ®åº“

```bash
pnpm run db:dev:reset
# ç­‰ä»·äºï¼šprisma migrate reset -f
# ä½œç”¨ï¼šåˆ é™¤æ‰€æœ‰æ•°æ® + é‡æ–°æ‰§è¡Œæ‰€æœ‰è¿ç§» + è¿è¡Œ seed
```

---

## è¿ç§»æœºåˆ¶

### è¿ç§»æ˜¯ä»€ä¹ˆï¼Ÿ
- æ•°æ®åº“çš„è¿ç§»æ˜¯ä¸€ä¸ªå¢é‡å˜æ›´çš„è¡Œä¸ºï¼Œéœ€è¦æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰è¿ç§»æ‰èƒ½ä¿è¯æ•°æ®åº“çš„ç»“æ„æ­£ç¡®
- **ä¸æ˜¯**ï¼šåˆ›å»ºæ–°æ•°æ®åº“å‰¯æœ¬
- **ä¸æ˜¯**ï¼šå…¨é‡é‡å»ºæ•°æ®åº“
- **æ˜¯**ï¼šåœ¨åŒä¸€æ•°æ®åº“ä¸ŠæŒ‰æ—¶é—´é¡ºåºæ‰§è¡Œç»“æ„å˜æ›´çš„ SQL è„šæœ¬

### è¿ç§»æ–‡ä»¶

å­˜å‚¨åœ¨ [`src/database/prisma/migrations/`]

```
migrations/
â”œâ”€â”€ 20231201120000_init/
â”‚   â””â”€â”€ migration.sql
â”œâ”€â”€ 20231202130000_add_user/
â”‚   â””â”€â”€ migration.sql
â””â”€â”€ _migrations_lock
```

**è§„åˆ™**ï¼š
- âœ… è¿ç§»æŒ‰æ—¶é—´æˆ³é¡ºåºæ‰§è¡Œ
- âŒ ä¸èƒ½éšæ„åˆ é™¤æˆ–ä¿®æ”¹å·²æ‰§è¡Œçš„è¿ç§»
- âœ… æ¯æ¬¡ schema å˜æ›´ç”Ÿæˆæ–°çš„å¢é‡è¿ç§»

---

## å…³é”®å‘½ä»¤é€ŸæŸ¥

```bash
# ç”Ÿæˆ Prisma Clientï¼ˆTypeScript ä»£ç ï¼‰
pnpm prisma generate

# å¼€å‘ç¯å¢ƒï¼šåˆ›å»ºè¿ç§» + æ‰§è¡Œ + ç”Ÿæˆ client
pnpm run db:dev:migrate

# æŸ¥çœ‹æ•°æ®åº“ï¼ˆWeb UIï¼‰
pnpm run db:studio

# ç›´æ¥æ¨é€ schemaï¼ˆä¸ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œé€‚åˆåŸå‹å¼€å‘ï¼‰
pnpm run db:dev:push

# é‡ç½®æ•°æ®åº“
pnpm run db:dev:reset

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
pnpm run db:prod:deploy
```

---

## å¸¸è§é—®é¢˜

### Q: ä¿®æ”¹äº† model ä½†æ•°æ®åº“æ²¡å˜åŒ–ï¼Ÿ
A: `.prisma` æ–‡ä»¶åªæ˜¯å£°æ˜ï¼Œéœ€è¦è¿è¡Œ `prisma migrate dev` æ‰ä¼šæ‰§è¡Œåˆ°æ•°æ®åº“

### Q: `database does not exist` é”™è¯¯ï¼Ÿ
A: PostgreSQL ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼š
```sql
CREATE DATABASE esti_blog;
```

---

## PostgreSQL æ•°æ®åº“ç®¡ç†å·¥å…·

åˆ›å»ºæ•°æ®åº“ä¸é™åˆ¶ä½¿ç”¨å“ªç§å·¥å…·ï¼Œåªè¦èƒ½æ‰§è¡Œ `CREATE DATABASE esti_blog` å³å¯ã€‚

### GUI å·¥å…·ï¼ˆå›¾å½¢ç•Œé¢ï¼‰

| å·¥å…· | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **DBeaver** | â€¢ å…è´¹å¼€æº<br>â€¢ è·¨å¹³å°<br>â€¢ æ”¯æŒå¤šç§æ•°æ®åº“ | â­ æ¨èæ–°æ‰‹ï¼ŒåŠŸèƒ½å…¨é¢ |
| **pgAdmin** | â€¢ PostgreSQL å®˜æ–¹å·¥å…·<br>â€¢ Web ç•Œé¢<br>â€¢ åŠŸèƒ½å®Œæ•´ | éœ€è¦å®Œæ•´ç®¡ç†åŠŸèƒ½ |
| **TablePlus** | â€¢ ç•Œé¢ç²¾ç¾<br>â€¢ æ€§èƒ½å¿«<br>â€¢ ä»˜è´¹è½¯ä»¶ | Mac ç”¨æˆ·ï¼Œè¿½æ±‚ä½“éªŒ |
| **DataGrip** | â€¢ JetBrains å‡ºå“<br>â€¢ æ™ºèƒ½æç¤ºå¼º<br>â€¢ ä»˜è´¹è®¢é˜… | å·²æœ‰ JetBrains å…¨å®¶æ¡¶ |
| **Postico** | â€¢ Mac åŸç”Ÿ<br>â€¢ ç•Œé¢ç®€æ´<br>â€¢ ä»˜è´¹è½¯ä»¶ | Mac ç”¨æˆ· |

### CLI å·¥å…·ï¼ˆå‘½ä»¤è¡Œï¼‰
* åœ¨è¿™ä¸ªé¡¹ç›®é‡Œé¢æˆ‘æ²¡æœ‰ä½¿ç”¨å‘½ä»¤ï¼Œå…¨ç¨‹ä½¿ç”¨ DBeaverï¼Œæ‰€ä»¥æ­¤å¤„ä¸åšè¯´æ˜ï¼Œéœ€è¦çš„æ—¶å€™ä¸Šç½‘æŸ¥ã€‚
### å·¥å…·é€‰æ‹©å»ºè®®

- **æ–°æ‰‹å¼€å‘è€…**ï¼šDBeaverï¼ˆå…è´¹ã€åŠŸèƒ½å…¨ã€ç•Œé¢å‹å¥½ï¼‰
- **å‘½ä»¤è¡Œçˆ±å¥½è€…**ï¼š`createdb` + `psql`ï¼ˆæœ€å¿«ï¼‰
- **Mac ç”¨æˆ·**ï¼šTablePlus æˆ– Posticoï¼ˆåŸç”Ÿä½“éªŒå¥½ï¼‰
- **å·²æœ‰è®¢é˜…**ï¼šDataGripï¼ˆå¼ºå¤§æ™ºèƒ½æç¤ºï¼‰

> **æç¤º**ï¼šå·¥å…·åªæ˜¯æ‰‹æ®µï¼Œæ ¸å¿ƒæ˜¯ç†è§£æ•°æ®åº“æœ¬èº«ã€‚é€‰æ‹©é¡ºæ‰‹çš„å³å¯ï¼Œä¸å¿…çº ç»“ã€‚

---

## Git ç‰ˆæœ¬æ§åˆ¶é…ç½®

### æ•°æ®åº“æ–‡ä»¶å­˜å‚¨æ–¹å¼å¯¹æ¯”

#### SQLiteï¼ˆæ–‡ä»¶å‹æ•°æ®åº“ï¼‰
```
é¡¹ç›®ç›®å½•/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ dev.db  â† æ•°æ®ç›´æ¥å­˜åœ¨é¡¹ç›®é‡Œ
```

**ç‰¹ç‚¹**ï¼š
- æ•°æ®åº“å°±æ˜¯ä¸€ä¸ª `.db` æ–‡ä»¶
- å­˜åœ¨é¡¹ç›®ç›®å½•ä¸­
- åˆ é™¤é¡¹ç›® = åˆ é™¤æ•°æ®

#### PostgreSQL/MySQLï¼ˆæœåŠ¡å‹æ•°æ®åº“ï¼‰
```
ç³»ç»Ÿæ•°æ®ç›®å½•/
â”œâ”€â”€ /var/lib/postgresql/data/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â””â”€â”€ 16384/  â† esti_blog æ•°æ®åº“çš„å®é™…æ•°æ®
â”‚   â””â”€â”€ pg_wal/

é¡¹ç›®ç›®å½•/
â””â”€â”€ .env  â† åªæœ‰è¿æ¥å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰å®é™…æ•°æ®
    DATABASE_URL="postgresql://..."
```

**ç‰¹ç‚¹**ï¼š
- æ•°æ®å­˜å‚¨åœ¨ç³»ç»Ÿä¸“é—¨ç›®å½•ï¼ˆä¸åœ¨é¡¹ç›®é‡Œï¼‰
- åˆ é™¤é¡¹ç›® â‰  åˆ é™¤æ•°æ®
- æ•°æ®ç”±æ•°æ®åº“æœåŠ¡ç‹¬ç«‹ç®¡ç†

### åº”è¯¥æ”¾å…¥ .gitignore çš„æ–‡ä»¶

| æ–‡ä»¶ç±»å‹ | ç¤ºä¾‹ | åŸå›  |
|---------|------|------|
| **ç¯å¢ƒå˜é‡** | `.env`, `.env.local` | åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆæ•°æ®åº“å¯†ç ï¼‰ |
| **SQLite æ•°æ®åº“** | `*.db`, `*.sqlite` | æœ¬åœ°å¼€å‘æ•°æ®ï¼Œä¸éœ€è¦å…±äº« |
| **SQLite ä¸´æ—¶æ–‡ä»¶** | `*.db-journal` | SQLite ä½¿ç”¨çš„ä¸´æ—¶é”æ–‡ä»¶ |
| **ç”Ÿæˆçš„å®¢æˆ·ç«¯** | `node_modules/@prisma/client` | è‡ªåŠ¨ç”Ÿæˆï¼Œå·²è¢« `node_modules` å¿½ç•¥ |

### ä¸åº”è¯¥æ”¾å…¥ .gitignore çš„æ–‡ä»¶

| æ–‡ä»¶ç±»å‹ | ç¤ºä¾‹ | åŸå›  |
|---------|------|------|
| **Schema å®šä¹‰** | `schema.prisma`, `*.prisma` | æ•°æ®åº“ç»“æ„å®šä¹‰ï¼Œå›¢é˜Ÿéœ€è¦ |
| **è¿ç§»æ–‡ä»¶** | `migrations/` ç›®å½• | æ•°æ®åº“ç‰ˆæœ¬å†å²ï¼Œå¿…é¡»åŒæ­¥ |
| **ç§å­è„šæœ¬** | `seed/` ç›®å½• | åˆå§‹åŒ–æ•°æ®é€»è¾‘ |
| **Prisma é…ç½®** | `prisma.config.ts` | Prisma é…ç½®æ–‡ä»¶ |
| **æ•°æ®åº“å®¢æˆ·ç«¯** | `src/database/client.ts` | è¿æ¥é…ç½®ä»£ç  |

### å®é™…é…ç½®ç¤ºä¾‹

```gitignore
# ç¯å¢ƒå˜é‡ï¼ˆåŒ…å«æ•°æ®åº“å¯†ç ï¼‰
.env*

# æ•°æ®åº“æ–‡ä»¶ï¼ˆä»… SQLiteï¼‰
*.db
*.sqlite
*.db-journal

# ä¾èµ–ï¼ˆåŒ…å« Prisma Client ç”Ÿæˆä»£ç ï¼‰
/node_modules
```

### Prisma Client ç”Ÿæˆä½ç½®

**é»˜è®¤é…ç½®**ï¼ˆæœ¬é¡¹ç›®ä½¿ç”¨ï¼‰:
```prisma
generator client {
  provider = "prisma-client-js"
  # é»˜è®¤è¾“å‡ºåˆ° node_modules/@prisma/client
}
```
âœ… ä¸éœ€è¦é¢å¤–é…ç½® `.gitignore`ï¼ˆå·²è¢« `/node_modules` è¦†ç›–ï¼‰

**è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„**:
```prisma
generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"  # è‡ªå®šä¹‰è·¯å¾„
}
```
âŒ éœ€è¦åœ¨ `.gitignore` æ·»åŠ ï¼š`/src/database/generated/client`

### ä¸ºä»€ä¹ˆ .env å¿…é¡»å¿½ç•¥ï¼Ÿ

```env
DATABASE_URL="postgresql://postgres:SECRET_PASSWORD@localhost:5432/esti_blog"
                                    â†‘
                          è¿™é‡Œæœ‰å¯†ç ï¼Œç»å¯¹ä¸èƒ½æäº¤ï¼
```

**åæœ**ï¼š
- ğŸš¨ å¯†ç æ³„éœ²åˆ° GitHub
- ğŸš¨ ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“å¯èƒ½è¢«å…¥ä¾µ
- ğŸš¨ API å¯†é’¥æš´éœ²
